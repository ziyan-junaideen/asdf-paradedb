#!/usr/bin/env bash
set -euo pipefail

fail() { echo "asdf-paradedb: $*" >&2; exit 1; }

version="${ASDF_INSTALL_VERSION:-${1:-}}"
download_path="${ASDF_DOWNLOAD_PATH:-${2:-}}"
[[ -n "$version" ]] || fail "missing version"
[[ -n "$download_path" ]] || fail "missing download path"

version_no_v="${version#v}"
tag="v${version_no_v}"

pg_major="${MISE_TOOL_OPTS__PG_MAJOR:-${PARADEDB_PG_MAJOR:-}}"
macos_codename="${MISE_TOOL_OPTS__MACOS_CODENAME:-${PARADEDB_MACOS_CODENAME:-}}"

detect_pg_major() {
  if command -v pg_config >/dev/null 2>&1; then
    local v
    v="$(pg_config --version 2>/dev/null | awk '{print $2}' | cut -d. -f1)"
    [[ "$v" =~ ^[0-9]+$ ]] && echo "$v" && return 0
  fi
  if command -v postgres >/dev/null 2>&1; then
    local v
    v="$(postgres --version 2>/dev/null | sed -E 's/.* ([0-9]+)\..*/\1/')"
    [[ "$v" =~ ^[0-9]+$ ]] && echo "$v" && return 0
  fi
  return 1
}

if [[ -z "$pg_major" ]]; then
  if pg_major="$(detect_pg_major)"; then
    echo "asdf-paradedb: detected PG_MAJOR=$pg_major" >&2
  else
    pg_major="16"
    echo "asdf-paradedb: could not detect PostgreSQL version; defaulting PG_MAJOR=$pg_major (set PARADEDB_PG_MAJOR to override)" >&2
  fi
fi

os="$(uname -s)"
arch="$(uname -m)"

if [[ "$os" != "Darwin" ]]; then
  fail "unsupported OS: $os (macOS only for now)"
fi
if [[ "$arch" != "arm64" ]]; then
  fail "unsupported architecture: $arch (arm64 only for now)"
fi

if [[ -z "$macos_codename" ]]; then
  major="$(sw_vers -productVersion | cut -d. -f1)"
  case "$major" in
    14) macos_codename="sonoma" ;;
    15) macos_codename="sequoia" ;;
    *) fail "unsupported macOS version $major; set PARADEDB_MACOS_CODENAME=sonoma|sequoia" ;;
  esac
fi

asset="pg_search@${pg_major}--${version_no_v}.arm64_${macos_codename}.pkg"
url="https://github.com/paradedb/paradedb/releases/download/${tag}/${asset}"

mkdir -p "$download_path"

curl -fsSL --retry 3 --retry-delay 2 -o "${download_path}/${asset}" "$url"
